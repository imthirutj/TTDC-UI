<div class="container">
    <h2 class="mt-4">Employee Attendance</h2>
    <!-- Filter Section -->
    <div class="card">
        <app-filter [filters]="filters" (filterChanged)="onFilterChanged($event)"
            (triggerParentFunction)="fetchEmployeeStatus()">
        </app-filter>
        <button style="width:77px" class="btn btn-primary" (click)="search()">Search</button>

    </div>

    <br>

    <!-- Employee Shifts Table -->
    <div style="overflow-y: auto; max-height: 500px;">
        <table class="table table-bordered">
            <thead class="sticky-header">
                <tr>
                    <th>Employee</th>
                    <th>#</th>
                    <th *ngFor="let date of getCurrentDates()">
                        <!-- Show date as dd MMM YYYY -->
                        {{ date | date: 'dd MMM yyyy' }}
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let employee of employees">
                    <td class="fw-bold">{{ employee.employeeName }}</td>
                    <td>
                        <div>
                            <p><b> Present Days</b> : {{ employee.reports.totalPresentDays }}</p>
                            <p><b> Absent Days</b> : {{ employee.reports.totalAbsentDays }}</p>

                        </div>
                        <i class="fas fa-info-circle" (click)="openEmployeeReportModal(employee)"></i>
                    </td>
                    <td *ngFor="let date of getCurrentDates()"
                        [ngStyle]="{ 'background-color': getStatusColor(employee.dates[date].status) }">

                        <div *ngIf="employee.dates[date]?.biometricData?.length">
                            <p class="mb-1">
                                <b>{{ employee.dates[date].biometricData[0]?.type }}</b>: {{
                                employee.dates[date].biometricData[0]?.time }}
                            </p>
                            <p class="mb-1">
                                <b>{{ employee.dates[date].biometricData[employee.dates[date].biometricData.length -
                                    1]?.type }}</b>: {{
                                employee.dates[date].biometricData[employee.dates[date].biometricData.length - 1]?.time
                                }}
                            </p>
                        </div>

                        <!-- Status Dropdown -->
                        <select class="form-select form-select-sm mt-2"
                            (change)="onStatusChange(employee, date, $event)" [(ngModel)]="employee.dates[date].status">
                            <option value="">Select</option>
                            <option *ngFor="let st of getStatusOptions(date)" [value]="st.key">{{ st.value }}</option>
                        </select>
                        <!-- Leave and OD Details -->
                        <div class="mt-2">
                            <div *ngIf="employee.dates[date]?.leave?.requested">
                                <b>Leave: {{ employee.dates[date].leave.status }}</b>
                                <button *ngIf="employee.dates[date].leave.status === 'PENDING'"
                                    class="btn btn-sm btn-outline-success mt-1">Approve</button>
                            </div>
                            <div *ngIf="employee.dates[date]?.od?.requested">
                                <b>OD: {{ employee.dates[date].od.status }}</b>
                                <button *ngIf="employee.dates[date].od.status === 'PENDING'"
                                    class="btn btn-sm btn-outline-success mt-1">Approve</button>
                            </div>
                        </div>


                        <i class="fas fa-info-circle" (click)="openModal(employee.dates[date])"></i>

                    </td>
                </tr>
            </tbody>
        </table>
    </div>


    <app-common-dialog [showDialog]="modalAttr.show" [dialogTitle]="modalAttr.title" [showCloseIcon]="true"
        [showSubmitButton]="false" (closeDialog)="closeModal()">

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Biometric Data</h5>
                <div
                    *ngIf="modalAttr.employeeDateDetails.biometricData && modalAttr.employeeDateDetails.biometricData.length">
                    <p *ngFor="let data of modalAttr.employeeDateDetails.biometricData">
                        {{ data.type }}: {{ data.time }}
                    </p>
                </div>
                <p
                    *ngIf="modalAttr.employeeDateDetails.biometricData && !modalAttr.employeeDateDetails.biometricData.length">
                    No biometric data found for this date.</p>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Day Status</h5>
                <p>{{ modalAttr.employeeDateDetails.status }}</p>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Leave Details</h5>
                <div *ngIf="modalAttr.employeeDateDetails.leave.requested">
                    <p><b>Leave Requested: {{ modalAttr.employeeDateDetails.leave.status }}</b></p>
                    <button *ngIf="modalAttr.employeeDateDetails.leave.status == 'PENDING'" (click)="null"
                        class="btn btn-primary">Approve</button>
                </div>
                <div *ngIf="!modalAttr.employeeDateDetails.leave.requested">
                    <p>No leave requested for this date.</p>
                </div>
            </div>
        </div>

        <!--OD-->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">OD Details</h5>
                <div *ngIf="modalAttr.employeeDateDetails.od.requested">
                    <b>OD Requested: {{ modalAttr.employeeDateDetails.od.status }}</b>
                    <button *ngIf="modalAttr.employeeDateDetails.od.status == 'PENDING'" (click)="null"
                        class="btn btn-primary">Approve</button>
                </div>
                <div *ngIf="!modalAttr.employeeDateDetails.od.requested">
                    <p>No OD requested for this date.</p>
                </div>
            </div>
        </div>
    </app-common-dialog>



    <app-common-dialog [showDialog]="modalAttrEmployeeReport.show" [dialogTitle]="modalAttrEmployeeReport.title"
        [showCloseIcon]="true" [showSubmitButton]="false" (closeDialog)="closeEmployeeReportModal()">

        <div class="card">
            <div class="card-body">
                <div>
                    <p>Total Present Days: {{ modalAttrEmployeeReport.employeeStatus.reports.totalPresentDays }}</p>
                    <p>Total Absent Days: {{ modalAttrEmployeeReport.employeeStatus.reports.totalAbsentDays }}</p>
                    <p>Total Leave Requested Days: {{ modalAttrEmployeeReport.employeeStatus.reports.leaveRequestedDays
                        }}</p>
                    <p>Total Leave Approved Days: {{ modalAttrEmployeeReport.employeeStatus.reports.leaveApprovedDays }}
                    </p>
                    <p>Total Leave Rejected Days: {{ modalAttrEmployeeReport.employeeStatus.reports.leaveRejectedDays }}
                    </p>
                    <p>Total OD Requested Days: {{ modalAttrEmployeeReport.employeeStatus.reports.odRequestedDays }}</p>
                    <p>Total OD Approved Days: {{ modalAttrEmployeeReport.employeeStatus.reports.odApprovedDays }}</p>
                    <p>Total OD Rejected Days: {{ modalAttrEmployeeReport.employeeStatus.reports.odRejectedDays }}</p>

                </div>
            </div>
        </div>
    </app-common-dialog>


    <div class="d-flex justify-content-between">
        <button class="btn btn-secondary" (click)="prevPage()" [disabled]="currentPage === 0">
            &#8592; <!-- Left Arrow -->
        </button>
        <button class="btn btn-secondary" (click)="nextPage()" [disabled]="currentPage === totalPages - 1">
            &#8594; <!-- Right Arrow -->
        </button>
    </div>

    <!--Submit-->
    <div>
        <button class="btn btn-primary" (click)="submit()">Submit</button>
    </div>
</div>